---
/**
 * Language Toggle Component
 *
 * Displays current language and provides a link to alternate language version.
 * Uses route-aware URL translation for proper Spanish slug handling.
 */

import { getAlternateUrl } from '@/i18n';
import type { Lang } from '@/i18n';

interface Props {
  currentLang: Lang;
  currentPath: string;
}

const { currentLang, currentPath } = Astro.props;

// Determine alternate language
const alternateLang: Lang = currentLang === 'en' ? 'es' : 'en';
const alternateLangLabel = alternateLang === 'en' ? 'English' : 'Español';

// Generate alternate URL using route-aware translation
const alternateUrl = getAlternateUrl(currentPath, currentLang, alternateLang);

// Accessibility label
const ariaLabel = currentLang === 'en'
  ? 'Switch to Spanish'
  : 'Cambiar a inglés';
---

<div class="language-toggle">
  <span class="current-lang" aria-current="page">
    {currentLang.toUpperCase()}
  </span>
  <span class="separator">|</span>
  <a
    href={alternateUrl}
    class="alternate-lang"
    aria-label={ariaLabel}
    hreflang={alternateLang}
    data-target-lang={alternateLang}
  >
    {alternateLangLabel}
  </a>
</div>

<script>
  /**
   * Language Toggle Persistence
   *
   * When user manually switches language, persist their choice in:
   * - localStorage (for client-side JS access)
   * - Cookie (for server-side middleware access)
   *
   * This ensures the preference is respected on subsequent visits.
   */
  // Note: No e.preventDefault() needed — localStorage.setItem and document.cookie
  // writes are synchronous and complete before the browser's default navigation fires.
  document.querySelectorAll('.language-toggle .alternate-lang').forEach((link) => {
    link.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLAnchorElement;
      const targetLang = target.getAttribute('data-target-lang');

      if (targetLang && (targetLang === 'en' || targetLang === 'es')) {
        // Persist in localStorage for client-side access
        localStorage.setItem('preferredLanguage', targetLang);

        // Persist in cookie for server-side middleware access
        // Path=/ ensures cookie is available on all routes
        // Max-age=31536000 = 1 year in seconds
        // SameSite=Lax for security while allowing top-level navigation
        document.cookie = `preferredLanguage=${targetLang};path=/;max-age=31536000;SameSite=Lax`;
      }
    });
  });
</script>

<style>
  .language-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .current-lang {
    color: var(--color-black);
    font-weight: 600;
  }

  .separator {
    color: var(--color-charcoal-soft);
  }

  .alternate-lang {
    color: var(--color-charcoal-soft);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .alternate-lang:hover {
    color: var(--color-primary);
    text-decoration: underline;
  }

  .alternate-lang:focus {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
    border-radius: 2px;
  }
</style>
